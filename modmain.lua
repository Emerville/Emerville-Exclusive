PrefabFiles = {
    -- LIGHT:
	"lightnecklace",	
	
	-- SURVIVAL:
	"wool_sack",
	"wool_sack2",
	"mechanicalfan",
	
	-- FARM:
	"compost_box",
	"freezereye",
	
	-- SCIENCE:	
	"trash_can",

	-- WAR:	
	"sword_rock",
	"mace_sting",		
	"fryingpan",
	"armor_rock",	
	"hat_rock",
	"hat_marble",	
	
	-- STRUCTURE:
	"crate_wooden",
	"crate_wooden_gingerbread",
	"crate_wooden_3d",	
	"crate_wooden_scary",
	"crate_wooden_present",
	"flowerbush",
	"xmastree",
	"snowman",
	"snowmanmelt1",
	"snowmanmelt2",
	"featherbrella",
	"featherbrellahammerchecker",	

	-- REFINE:
    "gift_red",
	
	-- MAGIC:
	"dark_axe",
	"dark_pickaxe",
	"growthstaff",
	
	-- DRESS:	
	"summerbandana",
	"gear_wings",
	"hat_hound",
	"pelt_hound",

	-- ANCIENT:	
	"box_gear",
	"gears_hat_goggles",
	"gears_staff",
	"gears_mace",
	"stampede",	
	"hornucopia",
	
	-- SLOT MACHINE:
	"ewecushat", --Unfinished Rework
	"spartahelmut",
	"spartaswurd", --Unfinished Rework	
	"baronsuit",
	"giftgamble",	
	"opulentlantern", --(aka Plantern)
	"elegantlantern",
	"reaperamulet",	
	"doctoramulet",	
	"thorn_crown",
	"notwilson",
	"nottrump",
	"magicdolls",
    "magicbag",
    "magicbag_classic",
	"magicpouch",
	"magicpouch_classic",
	"icypack",
	"frostpack",
	"chromebag",
	"chromebag2",
	"chromebag3",
	"chromebag4",
	"horsehead",
    	
	"trinket_pigbank",
	"efc",
	"hungerregenbuffefc",
	"goldenpiggy",
	"goldenegg",
	"goldendrum",
	"coffee",
	"coffeebeans",
	"coffeebush",
	"dug_coffeebush",
	"hollowhat", -- Unfinished
	"attyla",
	"attylaskull",
	"attyla_guano",
	-- not an actual item, but gotta include it:
	"attylalootspawner",
	
     -- CHARACTER DOLLS
	"dst_wolfgangdoll",
	"dst_wilsondoll",	
    "dst_wigfriddoll",
    "dst_willowdoll",
	"dst_wendydoll",
    "dst_wxdoll",
	"dst_wickerdoll",
    "dst_wesdoll",
	"dst_waxwelldoll",
	"dst_woodiedoll",
	"dst_webberdoll",
	"dst_winonadoll",
	"dst_wormwooddoll",
	"dst_wortoxdoll_uncorrupted",	
	"dst_wurtdoll_abyssal",
	"dst_warlydoll",
	"walterdoll",
	"dst_mysterydoll",

	-- EVENT: 
	"greencane", 
	"bluecane",
	"redcane",
	"blackcane",
	"whitecane",
    "chromecane", --A tribute to Lady Gaga's #1 album Chromatica
	"pinkcane",
	"purplecane",
	"orangecane",
	"greencanefake",
	"lightning_barrier",
	"scythe",
	"broomstick",
    "witch_hat",
	"santa_helper_hat",
	"musicbox",
	"musicbox2",
	
	"snowglobe",
    "snowyball",
	"santasnowman",
	
	"xmashat_default",
    "christmas_tree",
	"santa_hat",
	"gnomescarf",
	"christmaswendy",
	"christmaswalter",
	"christmaswx78",
	
	-- ADMIN:
	"hmsword", --Admin Sword	
	"vacuum_chest",
	"savecube",	
	"ice_chest",
	"eternal_torch",
	"eternaltorchfire",
    "maxwelllight",
	"maxwelllight_flame",
	"crate_metal",	
	"smart_pitchfork",
	"smart_paver",
	"weakpaw",
    "strongclaw",	
	"joznado",
	"jozaggro",
	"clawmeteor",
	"swing_charge",
	"crosshair",
	"bushhatex",
	"fuelsupplier",
	"reaperamulet2",

	-- TO DO:		
	"clockqueen",
	"clockqueen_charge",
	"schest",
	"bar",
	"metal",

	-- COSMETICS:
    "shark_teethhat",	
    "captainhat",
	"piratehat",
	"oxhat",	
	"snakeskinhat",	
	"armor_snakeskin",		
	"armor_lifejacket",
    "armor_windbreaker",	
	"bottlelantern",
    "palmleaf_umbrella",
	"eyebrella",
	"hamlet_hats.lua", 
	"spider.lua", -- Fix for Disguise Hat, so pigs and spiders don't attack you when wearing it!!!
	
	-- THIS IS HALLOWEEN!:
	"balloons_halloween",
	"pumpkin_lantern_halloween",
	"haunted_house",	
	"shadowbatenemy",
    "shadowbatminion",
	"batdamageability",	
	"infernalboss",
	"themask",
	"themasktornado",

    -- ALL I WANT FOR CHRISTMAS IS YOU!
	"casinochristmastree",
	"christmaswoodie",
	"statuecharlie",
	"rosekey",

    --Casino Structures
    "des_statue_charlie",
	--"des_river",
	--"des_raindrop",	
	--"des_river_circle",
	--"des_river_fishinghole",
	--"des_river_sinkhole",
	"palmtree",
	"sandcastle",	
	
	"kynoox_parkspike.lua",
	"kynoox_parkspike_short.lua",
	"kynoox_lamp_post.lua",
	"kynoox_lamp_short.lua",	
	"kynoox_post.lua",
	"kynoox_ivything.lua",
	"kynoox_urn.lua",	
    "casinomarblepillar",
    "casinostatueharp",
	"advanced_dwellings",
	"casino_chandelier",

    -- NPCS:
    "tradewebber", --OLD
    "casinowebber", --NEW
    "casinowickerbottom", --Gem Trader
	"halloweenwillow",
	"halloweenwendy",
	"halloweenwinona",
	"traderwolfgang",
--	"shipwreckedwoodie",
	"casinowoodlegs",
	
	--LIMITED EDITION:
	"beargerkit",
   	
	-- UNUSED:			
	"birchnuthat",
	"cactusmace",
	"chocolatebar",
	"ssfss",
	"glommpack",
	"beserker",	
	"stimpack",	
	
	"wolfyback",
	"bunnyback",
	"equip_pack",
	
	"book_carrot",			
    "greenfieldfx",
	"pinkfieldfx",
    "startburst",
    "shadowburst",	
    "startcandyburst",
    "candyburst",	
	"mech.lua",
	"locked_mech.lua",
	"pawn",
	"pawnb",
	"mechabat",
	"mechalance",
	"ancient1",
	"ancient4",	
	"ancient5",	
	"foodgen",
    "ladygaga",
	"statueladygaga",
	"staff_tornado",
    "coconut",
	"accomplishment_shrine",
	"firework_fx",
	"firework_fire",
	"firework",
	"armor_tungsten",
	"moonrockseed2",
	---
	"flan",
	"hat_goggles",
	"armor_beefalo",
	"gear_hat",
	"mermhats",
    
    -- Borrowed assets:
    "quagmire_wormwood_fx", -- From Re-Gorge-itated
}

Assets = {
	-- SOUNDS:
	Asset("SOUNDPACKAGE", "sound/animsparrow_peashooter.fev"),
	Asset("SOUND", "sound/animsparrow_peashooter.fsb"),	
	Asset("SOUNDPACKAGE", "sound/attylasounds.fev"),
	Asset("SOUND", "sound/attylasounds.fsb"),	
	Asset("SOUNDPACKAGE", "sound/fryingpan.fev"),
	Asset("SOUND", "sound/fryingpan.fsb"),
	Asset("SOUNDPACKAGE", "sound/musicbox.fev"),
	Asset("SOUND", "sound/musicbox.fsb"),
	Asset("SOUNDPACKAGE", "sound/woodlegs.fev"),
	Asset("SOUND", "sound/woodlegs.fsb"),

    -- LIGHT:
	Asset("ATLAS", "images/inventoryimages/lightnecklace.xml"),
    Asset("IMAGE", "images/inventoryimages/lightnecklace.tex"),
	
	-- SURVIVAL:	
	Asset("ATLAS", "images/inventoryimages/wool_sack.xml"),
    Asset("IMAGE", "images/inventoryimages/wool_sack.tex"),	
	Asset("ATLAS", "images/inventoryimages/mechanicalfan_3.xml"),
	Asset("IMAGE", "images/inventoryimages/mechanicalfan_3.tex"),

	-- FARM:
	Asset("ATLAS", "images/inventoryimages/compost_box.xml"),
	Asset("IMAGE", "images/inventoryimages/compost_box.tex"),
	Asset("ATLAS", "images/inventoryimages/freezereye.xml"),
    Asset("IMAGE", "images/inventoryimages/freezereye.tex"),	
	
	-- SCIENCE:
	Asset("ATLAS", "images/inventoryimages/trash_can.xml"),
	Asset("IMAGE", "images/inventoryimages/trash_can.tex"),

    -- WAR:
	Asset("ATLAS", "images/inventoryimages/sword_rock.xml"),
    Asset("IMAGE", "images/inventoryimages/sword_rock.tex"),	
	Asset("ATLAS", "images/inventoryimages/mace_sting.xml"),
    Asset("IMAGE", "images/inventoryimages/mace_sting.tex"),
	Asset("ATLAS", "images/inventoryimages/fryingpan.xml"),	
    Asset("IMAGE", "images/inventoryimages/fryingpan.tex"),
	Asset("ATLAS", "images/inventoryimages/armor_rock.xml"),
    Asset("IMAGE", "images/inventoryimages/armor_rock.tex"),	
	Asset("ATLAS", "images/inventoryimages/hat_rock.xml"),
    Asset("IMAGE", "images/inventoryimages/hat_rock.tex"),	
	Asset("ATLAS", "images/inventoryimages/hat_marble.xml"),
    Asset("IMAGE", "images/inventoryimages/hat_marble.tex"),				
	
    -- STRUCTURE:	
	Asset("ATLAS", "images/inventoryimages/crate_wooden.xml"),
	Asset("IMAGE", "images/inventoryimages/crate_wooden.tex"),
	Asset("ATLAS", "images/inventoryimages/crate_wooden_gingerbread.xml"),
	Asset("IMAGE", "images/inventoryimages/crate_wooden_gingerbread.tex"),
	Asset("ATLAS", "images/inventoryimages/snowman.xml"),
	Asset("IMAGE", "images/inventoryimages/snowman.tex"),
	Asset("ATLAS", "images/inventoryimages/flowerbush.xml"),
    Asset("IMAGE", "images/inventoryimages/flowerbush.tex"),
	Asset("ATLAS", "images/inventoryimages/xmastree.xml"),
    Asset("IMAGE", "images/inventoryimages/xmastree.tex"),
	Asset("ATLAS", "images/inventoryimages/featherbrella.xml"),
	Asset("IMAGE", "images/inventoryimages/featherbrella.tex"),		

	-- REFINE:
	Asset("ATLAS", "images/inventoryimages/tp_gift_red.xml"),
    Asset("IMAGE", "images/inventoryimages/tp_gift_red.tex"),
	Asset("ATLAS", "images/inventoryimages/chocolatebar.xml"),
    Asset("IMAGE", "images/inventoryimages/chocolatebar.tex"),	

    -- MAGIC:
	Asset("ATLAS", "images/inventoryimages/dark_axe.xml"),
    Asset("IMAGE", "images/inventoryimages/dark_axe.tex"),	
	Asset("ATLAS", "images/inventoryimages/dark_pickaxe.xml"),
    Asset("IMAGE", "images/inventoryimages/dark_pickaxe.tex"),	
	Asset("ATLAS", "images/inventoryimages/growthstaff.xml"),
    Asset("IMAGE", "images/inventoryimages/growthstaff.tex"),	
	Asset("ATLAS", "images/inventoryimages/lunarstaff.xml"),
    Asset("IMAGE", "images/inventoryimages/lunarstaff.tex"),	
		
	-- DRESS:
	Asset("ATLAS", "images/inventoryimages/summerbandana.xml"),	
    Asset("IMAGE", "images/inventoryimages/summerbandana.tex"),	
	Asset("ATLAS", "images/inventoryimages/gear_wings.xml"),
    Asset("IMAGE", "images/inventoryimages/gear_wings.tex"),

	-- ANCIENT:
	Asset("ATLAS", "images/inventoryimages/box_gear.xml"),
	Asset("IMAGE", "images/inventoryimages/box_gear.tex"),		
	Asset("ATLAS", "images/inventoryimages/gears_hat_goggles.xml"),
	Asset("IMAGE", "images/inventoryimages/gears_hat_goggles.tex"),
	Asset("ATLAS", "images/inventoryimages/gears_mace.xml"),
    Asset("IMAGE", "images/inventoryimages/gears_mace.tex"),	
	Asset("ATLAS", "images/inventoryimages/gears_staff.xml"),
	Asset("IMAGE", "images/inventoryimages/gears_staff.tex"),	
    Asset("ATLAS", "images/inventoryimages/stampede.xml"),
	Asset("IMAGE", "images/inventoryimages/stampede.tex"),
	Asset("ATLAS", "images/inventoryimages/hornucopia.xml"),
    Asset("IMAGE", "images/inventoryimages/hornucopia.tex"),	
	
    -- ADMIN:
	Asset("ATLAS", "images/inventoryimages/eternal_torch.xml"),	
    Asset("IMAGE", "images/inventoryimages/eternal_torch.tex"),	
    Asset("IMAGE", "images/inventoryimages/evillight.tex"),
	Asset("ATLAS", "images/inventoryimages/evillight.xml"),
	Asset("ATLAS", "images/inventoryimages/ice_chest.xml"),
	Asset("IMAGE", "images/inventoryimages/ice_chest.tex"),		
	Asset("ATLAS", "images/inventoryimages/vacuum_chest.xml"),
	Asset("IMAGE", "images/inventoryimages/vacuum_chest.tex"),	
    Asset("ATLAS", "images/inventoryimages/savecube.xml"),
	Asset("IMAGE", "images/inventoryimages/savecube.tex"),
    Asset("ATLAS", "images/inventoryimages/hmsword.xml"),
	Asset("IMAGE", "images/inventoryimages/hmsword.tex"),
	Asset("ATLAS", "images/inventoryimages/strongclaw.xml"),
	Asset("IMAGE", "images/inventoryimages/strongclaw.tex"),
	Asset("ATLAS", "images/inventoryimages/weakpaw.xml"),
	Asset("IMAGE", "images/inventoryimages/weakpaw.tex"),	
    Asset("ATLAS", "images/inventoryimages/bushhatex.xml"),
    Asset("IMAGE", "images/inventoryimages/bushhatex.tex"),

	-- COSMETICS:	
	Asset("ATLAS", "images/inventoryimages/hat_captain.xml"),
	Asset("IMAGE", "images/inventoryimages/hat_captain.tex"),	
	Asset("ATLAS", "images/inventoryimages/hat_pirate.xml"),
	Asset("IMAGE", "images/inventoryimages/hat_pirate.tex"),
	Asset("ATLAS", "images/inventoryimages/hat_ox.xml"),
	Asset("IMAGE", "images/inventoryimages/hat_ox.tex"),
	Asset("ATLAS", "images/inventoryimages/hat_snakeskin.xml"),
	Asset("IMAGE", "images/inventoryimages/hat_snakeskin.tex"),
	Asset("ATLAS", "images/inventoryimages/armor_snakeskin.xml"),
	Asset("IMAGE", "images/inventoryimages/armor_snakeskin.tex"),
	Asset("ATLAS", "images/inventoryimages/armor_lifejacket.xml"),
	Asset("IMAGE", "images/inventoryimages/armor_lifejacket.tex"),
	Asset("ATLAS", "images/inventoryimages/lantern_bottle.xml"),
	Asset("IMAGE", "images/inventoryimages/lantern_bottle.tex"),
	Asset("ATLAS", "images/inventoryimages/donhatsharkteeth.xml"),
	Asset("IMAGE", "images/inventoryimages/donhatsharkteeth.tex"),
	Asset("ATLAS", "images/inventoryimages/dontropicalparasol.xml"),
	Asset("IMAGE", "images/inventoryimages/dontropicalparasol.tex"),
	Asset("ATLAS", "images/inventoryimages/donarmorwindbreaker.xml"),
	Asset("IMAGE", "images/inventoryimages/donarmorwindbreaker.tex"),	
	Asset("ATLAS", "images/inventoryimages/eyebrella.xml"),
	Asset("IMAGE", "images/inventoryimages/eyebrella.tex"),
	Asset("ATLAS", "images/inventoryimages/hamlet_hats.xml"),
	Asset("IMAGE", "images/inventoryimages/hamlet_hats.tex"),

    -- CASINO:	
	Asset("IMAGE", "images/inventoryimages/fence.tex"),
	Asset("ATLAS", "images/inventoryimages/fence.xml"),	
	Asset("IMAGE", "images/inventoryimages/fence2.tex"),
	Asset("ATLAS", "images/inventoryimages/fence2.xml"),
	Asset("IMAGE", "images/inventoryimages/lamp_post.tex"),
	Asset("ATLAS", "images/inventoryimages/lamp_post.xml"),
	Asset("IMAGE", "images/inventoryimages/lamp_short.tex"),
	Asset("ATLAS", "images/inventoryimages/lamp_short.xml"),
	Asset("IMAGE", "images/inventoryimages/bollard.tex"),
	Asset("ATLAS", "images/inventoryimages/bollard.xml"),
	Asset("IMAGE", "images/inventoryimages/ivy.tex"),
	Asset("ATLAS", "images/inventoryimages/ivy.xml"),
	Asset("IMAGE", "images/inventoryimages/urn.tex"),
	Asset("ATLAS", "images/inventoryimages/urn.xml"),
    Asset("IMAGE", "images/inventoryimages/mini_yurt.tex"),
	Asset("ATLAS", "images/inventoryimages/mini_yurt.xml"),
	Asset("IMAGE", "images/inventoryimages/mini_tipi.tex"),
	Asset("ATLAS", "images/inventoryimages/mini_tipi.xml"),
	
	-- SLOT MACHINE:
	Asset("ATLAS", "images/inventoryimages/giftgamble.xml"),
    Asset("IMAGE", "images/inventoryimages/giftgamble.tex"),
	Asset("ATLAS", "images/inventoryimages/frostpack.xml"),
    Asset("IMAGE", "images/inventoryimages/frostpack.tex"),
	Asset("ATLAS", "images/inventoryimages/icypack.xml"),
    Asset("IMAGE", "images/inventoryimages/icypack.tex"),
    Asset("ATLAS", "images/inventoryimages/magicpouch.xml"),
    Asset("IMAGE", "images/inventoryimages/magicpouch.tex"),
    Asset("ATLAS", "images/inventoryimages/magicpouch_classic.xml"),
    Asset("IMAGE", "images/inventoryimages/magicpouch_classic.tex"),	
    Asset("ATLAS", "images/inventoryimages/magicbag.xml"),
    Asset("IMAGE", "images/inventoryimages/magicbag.tex"),
    Asset("ATLAS", "images/inventoryimages/magicbag_classic.xml"),
    Asset("IMAGE", "images/inventoryimages/magicbag_classic.tex"),
	Asset("ATLAS", "images/inventoryimages/malamilantern.xml"),
    Asset("IMAGE", "images/inventoryimages/malamilantern.tex"),
	Asset("ATLAS", "images/inventoryimages/malamilantern_lit.xml"),
    Asset("IMAGE", "images/inventoryimages/malamilantern_lit.tex"),
	Asset("ATLAS", "images/inventoryimages/aip_horse_head.xml"),
	Asset("IMAGE", "images/inventoryimages/aip_horse_head.tex"),
	Asset("ATLAS", "images/inventoryimages/reaperamulet.xml"),
	Asset("IMAGE", "images/inventoryimages/reaperamulet.tex"),
	Asset("ATLAS", "images/inventoryimages/magicdolls.xml"),
    Asset("IMAGE", "images/inventoryimages/magicdolls.tex"),
	Asset("ATLAS", "images/inventoryimages/ewecushat.xml"),
    Asset("IMAGE", "images/inventoryimages/ewecushat.tex"),
    Asset("ATLAS", "images/inventoryimages/spartahelmut.xml"),
	Asset("ATLAS", "images/inventoryimages/spartaswurd.xml"),	
	Asset("ATLAS", "images/inventoryimages/baronsuit.xml"),
    Asset("IMAGE", "images/inventoryimages/baronsuit.tex"),
    Asset("ATLAS", "images/inventoryimages/thorn_crown.xml"),
    Asset("IMAGE", "images/inventoryimages/thorn_crown.tex"),		
	Asset("ATLAS", "images/inventoryimages/notwilson.xml"),
    Asset("IMAGE", "images/inventoryimages/notwilson.tex"),
	Asset("ATLAS", "images/inventoryimages/friend_log.xml"),
    Asset("IMAGE", "images/inventoryimages/friend_log.tex"),
	Asset("IMAGE", "images/inventoryimages/coffee.tex"),
	Asset("ATLAS", "images/inventoryimages/coffee.xml"),
	Asset("ATLAS", "images/inventoryimages/volcanoinventory.xml"),
	Asset("IMAGE", "images/inventoryimages/volcanoinventory.tex"),
	Asset("ATLAS", "images/inventoryimages/dug_coffeebush.xml"),
	Asset("IMAGE", "images/inventoryimages/dug_coffeebush.tex"),
    Asset("ATLAS", "images/inventoryimages/efc.xml"),
	Asset("IMAGE", "images/inventoryimages/efc.tex"),
	Asset("ATLAS", "images/inventoryimages/goldenegg.xml"),
    Asset("IMAGE", "images/inventoryimages/goldenegg.tex"),
    Asset("ATLAS", "images/inventoryimages/gflesh.xml"),
	Asset("IMAGE", "images/inventoryimages/gflesh.tex"),		
		
    -- EVENT:
	Asset("ATLAS", "images/inventoryimages/green_cane.xml"),
    Asset("IMAGE", "images/inventoryimages/green_cane.tex"),	
	Asset("ATLAS", "images/inventoryimages/blue_cane.xml"),
    Asset("IMAGE", "images/inventoryimages/blue_cane.tex"),
	Asset("ATLAS", "images/inventoryimages/red_cane.xml"),
    Asset("IMAGE", "images/inventoryimages/red_cane.tex"),
	Asset("ATLAS", "images/inventoryimages/blackcane.xml"),
    Asset("IMAGE", "images/inventoryimages/blackcane.tex"),
	Asset("ATLAS", "images/inventoryimages/whitecane.xml"),
    Asset("IMAGE", "images/inventoryimages/whitecane.tex"),
	Asset("ATLAS", "images/inventoryimages/chromecane.xml"),
    Asset("IMAGE", "images/inventoryimages/chromecane.tex"),
	Asset("ATLAS", "images/inventoryimages/pinkcane.xml"),
    Asset("IMAGE", "images/inventoryimages/pinkcane.tex"),	
	Asset("ATLAS", "images/inventoryimages/purplecane.xml"),
    Asset("IMAGE", "images/inventoryimages/purplecane.tex"),
	Asset("ATLAS", "images/inventoryimages/orangecane.xml"),
    Asset("IMAGE", "images/inventoryimages/orangecane.tex"),
	Asset("ATLAS", "images/inventoryimages/scythe.xml"),
    Asset("IMAGE", "images/inventoryimages/scythe.tex"),	
	Asset("ATLAS", "images/inventoryimages/witch_hat.xml"),
    Asset("IMAGE", "images/inventoryimages/witch_hat.tex"),
    Asset("IMAGE", "images/inventoryimages/broomstick.tex"),
    Asset("ATLAS", "images/inventoryimages/broomstick.xml"),	
	Asset("ATLAS", "images/inventoryimages/santa_helper_hat.xml"),
    Asset("IMAGE", "images/inventoryimages/santa_helper_hat.tex"),
	Asset("ATLAS", "images/inventoryimages/snowglobe.xml"),
    Asset("IMAGE", "images/inventoryimages/snowglobe.tex"),	
	Asset("ATLAS", "images/inventoryimages/snowyball.xml"),
    Asset("IMAGE", "images/inventoryimages/snowyball.tex"),
	Asset("ATLAS", "images/inventoryimages/musicbox.xml"),
    Asset("IMAGE", "images/inventoryimages/musicbox.tex"),		
	
	-- HOLIDAYS:
	Asset("ATLAS", "images/inventoryimages/haunted_house.xml"),
	Asset("IMAGE", "images/inventoryimages/haunted_house.tex"),		
    Asset("ATLAS", "images/inventoryimages/christmas_tree.xml"),
    Asset("IMAGE", "images/inventoryimages/christmas_tree.tex"),
    Asset("ATLAS", "images/inventoryimages/rosekey.xml"),
    Asset("IMAGE", "images/inventoryimages/rosekey.tex"),

	-- MISC	
	Asset("ATLAS", "images/inventoryimages/hollowhat.xml"),	
	Asset("ATLAS", "images/inventoryimages/birchnuthat.xml"),
	Asset("ATLAS", "images/inventoryimages/cactusmace.xml"),
	Asset("ATLAS", "images/inventoryimages/glommpack.xml"),
	Asset("IMAGE", "images/inventoryimages/glommpack.tex"),
	Asset("ATLAS", "images/inventoryimages/armor_tungsten.xml"),
    Asset("IMAGE", "images/inventoryimages/armor_tungsten.tex"),
    Asset("ATLAS", "images/inventoryimages/gear_hat.xml"),
    Asset("IMAGE", "images/inventoryimages/gear_hat.tex"),	
	Asset("ATLAS", "images/inventoryimages/beserker.xml"),
	Asset("IMAGE", "images/inventoryimages/beserker.tex"),	
	Asset("ATLAS", "images/inventoryimages/stimpack.xml"),
	Asset("IMAGE", "images/inventoryimages/stimpack.tex"),	
	Asset("ATLAS", "images/inventoryimages/crate_metal.xml"),
    Asset("IMAGE", "images/inventoryimages/crate_metal.tex"),	
	Asset("ATLAS", "images/inventoryimages/wolfyback.xml"),	
	Asset("IMAGE", "images/inventoryimages/wolfyback.tex"),	
	Asset("ATLAS", "images/inventoryimages/bunnyback.xml"),
	Asset("IMAGE", "images/inventoryimages/bunnyback.tex"),	
	Asset("ATLAS", "images/inventoryimages/equip_pack.xml"),
	Asset("IMAGE", "images/inventoryimages/equip_pack.tex"),
	Asset("ATLAS", "images/inventoryimages/hat_hound.xml"),
	Asset("IMAGE", "images/inventoryimages/hat_hound.tex"),		
	Asset("ATLAS", "images/inventoryimages/hat_goggles.xml"),
	Asset("IMAGE", "images/inventoryimages/hat_goggles.tex"),	
	Asset("ATLAS", "images/inventoryimages/pelt_hound.xml"),
    Asset("IMAGE", "images/inventoryimages/pelt_hound.tex"),		
	Asset("ATLAS", "images/inventoryimages/armor_beefalo.xml"),
    Asset("IMAGE", "images/inventoryimages/armor_beefalo.tex"),		
	Asset("ATLAS", "images/inventoryimages/book_carrot.xml"),
	Asset("IMAGE", "images/inventoryimages/book_carrot.tex"),	
    Asset("ATLAS", "images/inventoryimages/bar.xml"),
    Asset("IMAGE", "images/inventoryimages/bar.tex"),
	Asset("ATLAS", "images/inventoryimages/metal.xml"),	-- Atlas for inventory TEX
    Asset("IMAGE", "images/inventoryimages/metal.tex"),	-- TEX for inventory
	Asset("ATLAS", "images/inventoryimages/mech_hay_item.xml"),
	Asset("ATLAS", "images/inventoryimages/mech_wood_item.xml"),
	Asset("ATLAS", "images/inventoryimages/mech_stone_item.xml"),
	Asset("ATLAS", "images/inventoryimages/mech_ruins_item.xml"),
	Asset("ATLAS", "images/inventoryimages/mech_moonrock_item.xml"),
	Asset("ATLAS", "images/inventoryimages/locked_mech_stone_item.xml"),
	Asset("ATLAS", "images/inventoryimages/locked_mech_ruins_item.xml"),
	Asset("ATLAS", "images/inventoryimages/locked_mech_moonrock_item.xml"),
	Asset("IMAGE", "images/inventoryimages/smartpfp.tex"),
	Asset("ATLAS", "images/inventoryimages/smartpfp.xml"),
    Asset("IMAGE", "images/inventoryimages/puluji.tex"),
    Asset("ATLAS", "images/inventoryimages/puluji.xml"),
	Asset("IMAGE", "images/inventoryimages/flan.tex"),
	Asset("ATLAS", "images/inventoryimages/flan.xml"),	
	Asset("ATLAS", "images/inventoryimages/mermhat.xml"),
    Asset("IMAGE", "images/inventoryimages/mermhat.tex"),
	Asset("ATLAS", "images/inventoryimages/mermlighthat.xml"),
    Asset("IMAGE", "images/inventoryimages/mermlighthat.tex"),
}

-----------------------------------------------------------
--~ [Minimap Icons] ~--
-----------------------------------------------------------
--Structures & Items--
AddMinimapAtlas("images/inventoryimages/xmastree.xml")
AddMinimapAtlas("images/inventoryimages/freezereye.xml")
AddMinimapAtlas("images/inventoryimages/mechanicalfan.xml")
AddMinimapAtlas("images/inventoryimages/trash_can.xml")
AddMinimapAtlas("images/inventoryimages/compost_box.xml")
AddMinimapAtlas("images/inventoryimages/vacuum_chest.xml")
AddMinimapAtlas("images/inventoryimages/ice_chest.xml")
AddMinimapAtlas("images/inventoryimages/crate_wooden.xml")
AddMinimapAtlas("images/inventoryimages/crate_metal.xml")
AddMinimapAtlas("images/inventoryimages/wool_sack.xml")
AddMinimapAtlas("images/inventoryimages/mini_yurt.xml")
AddMinimapAtlas("images/inventoryimages/mini_tipi.xml")

--Character Dolls--
AddMinimapAtlas("images/inventoryimages/wilsondoll.xml")
AddMinimapAtlas("images/inventoryimages/willowdoll.xml")
AddMinimapAtlas("images/inventoryimages/wickerdoll.xml")
AddMinimapAtlas("images/inventoryimages/wolfgangdoll.xml")
AddMinimapAtlas("images/inventoryimages/wxdoll.xml")
AddMinimapAtlas("images/inventoryimages/wendydoll.xml")
AddMinimapAtlas("images/inventoryimages/woodiedoll.xml")
AddMinimapAtlas("images/inventoryimages/webberdoll.xml")
AddMinimapAtlas("images/inventoryimages/waxwelldoll.xml")
AddMinimapAtlas("images/inventoryimages/wigfriddoll.xml")
AddMinimapAtlas("images/inventoryimages/wesdoll.xml")
AddMinimapAtlas("images/inventoryimages/mysterydoll.xml")
AddMinimapAtlas("images/inventoryimages/winonadoll.xml")
AddMinimapAtlas("images/inventoryimages/wormwooddoll.xml")
AddMinimapAtlas("images/inventoryimages/wortoxdoll_uncorrupted.xml")

--Local Files
local require = GLOBAL.require
local TUNING = GLOBAL.TUNING
local Recipe = GLOBAL.Recipe
local Ingredient = GLOBAL.Ingredient
local TECH = GLOBAL.TECH
local SpawnPrefab = GLOBAL.SpawnPrefab
--
local STRINGS = GLOBAL.STRINGS
local RECIPETABS = GLOBAL.RECIPETABS
local ACTIONS = GLOBAL.ACTIONS
local ActionHandler = GLOBAL.ActionHandler

--much cleaner, isn't it? -M
modimport("strings.lua")
modimport("recipes.lua")
modimport("postinits.lua")
modimport("scripts/cookpotfix.lua")
modimport("scripts/customcontainers.lua")

--If I had one gold coin for every day Luis wasn't iconic, I'd be broke and living in the Emerslums with the rest of the Emer-rats ãƒ„
--modimport("koreanwaffles.lua") --ALL moved to Modmain. --Luis

-- Custom modded reskins by Platypus
modimport("scripts/customreskins.lua")
	
-- TheWorld.ismastersim is not yet available
--[[local ismastersim = GLOBAL.TheNet:GetIsMasterSimulation() and not GLOBAL.TheShard:IsSecondary()

if ismastersim then
    local function AddReincarnationMemory(inst)
        inst:AddComponent("reincarnationmemory")
    end
    AddPrefabPostInit("world", AddReincarnationMemory)


    local function ReplaceNewSpawn(inst)
        local OnNewSpawn_original = inst.OnNewSpawn
        inst.OnNewSpawn = function(inst)
            local return_value = nil

            if OnNewSpawn_original then
                return_value = OnNewSpawn_original(inst)
            end

            if GLOBAL.TheWorld.components.reincarnationmemory ~= nil then
                GLOBAL.TheWorld.components.reincarnationmemory:RestorePlayer(inst)
            end

            return return_value
        end
    end
    AddPlayerPostInit(ReplaceNewSpawn)
end]]

-----------------------------------------------------------
--~ [Tuning & Misc] ~--
-----------------------------------------------------------
--Tuning
TUNING.GOLD_VALUES.RAREMEAT = 4

TUNING.ATTYLA_HEALTH = 100
TUNING.ATTYLA_RUN_SPEED = 6
TUNING.ATTYLA_GUANO_FERTILIZE = TUNING.GUANO_FERTILIZE/2
TUNING.ATTYLA_GUANO_SOILCYCLES = TUNING.GUANO_SOILCYCLES/2
TUNING.ATTYLA_GUANO_WITHEREDCYCLES = TUNING.GUANO_WITHEREDCYCLES/2
TUNING.ATTYLA_GUANO_FUEL = TUNING.MED_FUEL/2
TUNING.ATTYLA_GUANO_BURNTIME = TUNING.MED_BURNTIME/2

TUNING.ROCK_FRUIT_LOOT = {ANGLE = 65, SPEED = -1.8, HEIGHT = 0.5, RIPE_CHANCE = 0.65, SEED_CHANCE = 0.00, MAX_SPAWNS = 10}

--Make Ingredient
AddIngredientValues({"goldenegg",}, {egg=4})
AddIngredientValues({"goldendrum",}, {goldendrum=1})
AddIngredientValues({"coffeebeans_cooked",}, {coffeebeans_cooked=1})

--New Fuel
GLOBAL.FUELTYPE.ANIMSPARROWGUN = "GEARS"
GLOBAL.FUELTYPE.HOUNDHAT = "SPIDERHAT"
GLOBAL.FUELTYPE.DSTDOLL = "DSTDOLL"
GLOBAL.FUELTYPE.BLUEGEM = "BLUEGEM"
GLOBAL.FUELTYPE.PURPLEGEM = "PURPLEGEM"

--AddPrefabPostInit
AddPrefabPostInit("marble", 
	function (inst)
		inst:AddComponent("tradable")		
	end)

AddPrefabPostInit("bluegem", 
	function (inst)
		inst:AddComponent("fuel")		
		inst.components.fuel.fueltype = "BLUEGEM"
	end)
	
AddPrefabPostInit("purplegem", 
	function (inst)
		inst:AddComponent("fuel")		
		inst.components.fuel.fueltype = "PURPLEGEM"
	end)

AddPrefabPostInit("gears", 
	function (inst)
		inst:AddComponent("fuel")		
		inst.components.fuel.fueltype = "GEARS"
		inst:AddComponent("tradable")
	end)
	
AddPrefabPostInit("spiderhat", 
	function (inst)
		inst:AddComponent("fuel")		
		inst.components.fuel.fueltype = "SPIDERHAT"
	end)
	
AddPrefabPostInit("magicdolls", 
	function (inst)
		inst:AddComponent("fuel")		
		inst.components.fuel.fueltype = "DSTDOLL"
	end)	

AddPrefabPostInit("rock_avocado_bush",
    function (inst)
        inst:RemoveComponent("workable")
        inst:RemoveComponent("burnable")
    end)

AddPrefabPostInit("trap_starfish",
    function (inst)
        inst:RemoveComponent("workable")
    end)	
	
AddPrefabPostInit("woodie", 
	function(inst)
	if not GLOBAL.TheNet:GetIsServer() then 
		return 
	end
    inst.components.tackler:AddWorkAction(GLOBAL.ACTIONS.HAMMER, 0)
	end)

--KoreanIcon doing his thing.
AddPrefabPostInit("firestaff", function(inst)
    if not GLOBAL.TheWorld.ismastersim then
        return inst
    end
    
	local _onattack_red = inst.components.weapon.onattack

	local function OnAttack(inst, attacker, target, skipsanity)
		if target:HasTag("structure") then
			return
		end
		_onattack_red(inst, attacker, target, skipsanity)
	end

	inst.components.weapon.onattack = OnAttack
end)

AddPrefabPostInit("greenstaff", function(inst)
    if not GLOBAL.TheWorld.ismastersim then
        return inst
    end

	local _destroystructure = inst.components.spellcaster.spell

	local function DestroyStructure(staff, target)
		if target:HasTag("structure") or target:HasTag("currency") then
			local caster = staff.components.inventoryitem.owner
			if caster.components.talker then
				caster.components.talker:Say("The Emerville government is looking at me suspiciously...")
			end
			return
		end
		_destroystructure(staff, target)
	end

	inst.components.spellcaster.spell = DestroyStructure
end)
	
-------------------------------------------
-- Remove Scarecrow Obstacle Physics 
-------------------------------------------
AddPrefabPostInit("scarecrow", 
	function (inst)
		GLOBAL.RemovePhysicsColliders(inst)
	end)

--Cookpot Recipe Adder	
local efc_recipe = {		
		name = "efc",
		test = function(cooker, names, tags) return names.goldendrum and (tags.goldendrum and tags.goldendrum>= 4) end,
		priority = 30,	
		weight = 1,		
		foodtype = "MEAT",
		health = 3,
		hunger = 50,
		perishtime = nil, 
		sanity = 25,
		cooktime = 2,
		overridebuild = "efc",
		tags = {"catfood"},
	}
AddCookerRecipe("cookpot", efc_recipe)	
AddCookerRecipe("portablecookpot", efc_recipe)
AddCookerRecipe("archive_cookpot", efc_recipe)

local coffee =
{
    name = "coffee",
    test = function(cooker, names, tags) return names.coffeebeans_cooked and (names.coffeebeans_cooked == 4 or (names.coffeebeans_cooked == 3 and tags.dairy)) end,
    priority = 30,
    weight = 1,
    foodtype = "GOODIES",
	health = TUNING.HEALING_SMALL,
	hunger = TUNING.CALORIES_TINY,
    sanity = -TUNING.SANITY_TINY,
    cooktime = .5,
    tags = {},
}
AddCookerRecipe("cookpot",coffee)
AddCookerRecipe("portablecookpot",coffee)
AddCookerRecipe("archive_cookpot", coffee)

-----------------------------------------------------
-- Scythe Blink Sanity Drain - Code by KoreanWaffles
-----------------------------------------------------
----!!
local Action = GLOBAL.Action
----!!
ACTIONS.BLINK.fn = function(act)
    local act_pos = act:GetActionPoint()
    if act.invobject ~= nil then
        if act.invobject.components.blinkstaff ~= nil then
            if act.invobject:HasTag("scythe") and act.doer.components.sanity and act.doer.components.sanity.current >= 25 then
                return act.invobject.components.blinkstaff:Blink(act_pos, act.doer)
            elseif not act.invobject:HasTag("scythe") then
                return act.invobject.components.blinkstaff:Blink(act_pos, act.doer)
            else
                return false
            end
        end
    elseif act.doer ~= nil
        and act.doer.sg ~= nil
        and act.doer.sg.currentstate.name == "portal_jumpin_pre"
        and act.pos ~= nil
        and act.doer.components.inventory ~= nil
        and act.doer.components.inventory:Has("wortox_soul", 1) then
        act.doer.components.inventory:ConsumeByName("wortox_soul", 1)
        act.doer.sg:GoToState("portal_jumpin", act_pos)
        return true
    end
end

--------------------------------
-- Sparta Helmet (Golden Helmet)
--------------------------------
AddComponentPostInit("combat", function(Combat)
	local OldCalcDamage = Combat.CalcDamage
	Combat.CalcDamage = function(self, target, weapon, ...)
		local old_dmg = nil
		if target and self.inst:HasTag("spartan") and self.inst.components.combat.damagemultiplier ~= nil then
			old_dmg = self.inst.components.combat.damagemultiplier
			self.inst.components.combat.damagemultiplier = old_dmg+0.25
		elseif target and self.inst:HasTag("spartan") and self.inst.components.combat.damagemultiplier == nil then
			old_dmg = 1
			self.inst.components.combat.damagemultiplier = old_dmg+0.25
		end
		local ret = OldCalcDamage(self, target, weapon, ...)
		if old_dmg then
			self.inst.components.combat.damagemultiplier = old_dmg
		end
		return ret
	end
end)

-------------
-- WALL GATES
-------------
AddAction("CLOSE", "Close", function(act)
	local tar = act.target
    if tar and tar.components.wallgates and tar.components.wallgates:IsOpen() then
		tar.components.wallgates:CloseWall(tar)
		return true
    end
end)

AddStategraphActionHandler("wilson", ActionHandler(GLOBAL.ACTIONS.CLOSE, "give"))

AddStategraphActionHandler("wilson_client", ActionHandler(GLOBAL.ACTIONS.CLOSE, "give"))

AddAction("OPEN", "Open", function(act)
	local tar = act.target
    if tar and tar.components.wallgates and not tar.components.wallgates:IsOpen() then
        tar.components.wallgates:OpenWall(tar)
        return true
    end
end)

AddStategraphActionHandler("wilson", ActionHandler(GLOBAL.ACTIONS.OPEN, "give"))

AddStategraphActionHandler("wilson_client", ActionHandler(GLOBAL.ACTIONS.OPEN, "give"))

AddComponentAction("SCENE", "wallgates", function(inst, doer, actions, right)
    if inst and not inst:HasTag("broken") then
			if right and inst:HasTag("opened") then
				table.insert(actions, GLOBAL.ACTIONS.CLOSE)
			elseif right and not inst:HasTag("opened") then
				table.insert(actions, GLOBAL.ACTIONS.OPEN)
			end
	end
end)
	
function HighlightPostInit(self)
	self.Highlight = function(self,r,g,b)
		self.highlit = true
		if self.inst:IsValid() and self.inst:HasTag("player") or GLOBAL.CanEntitySeeTarget(GLOBAL.ThePlayer, self.inst) then
			local m = .2
			if self.inst:HasTag("wallgate") or self.inst:HasTag("wallgateitem") then
				self.highlight_add_colour_red = 0.3
				self.highlight_add_colour_green = 0.3
				self.highlight_add_colour_blue = 0
			else
				self.highlight_add_colour_red = r or m
				self.highlight_add_colour_green = g or m
				self.highlight_add_colour_blue = b or m
			end
		end
		self:ApplyColour()    
	end
end	
	
AddComponentPostInit("highlight", HighlightPostInit)

------------
-- Piggy bank actions
------------

local PIGBANKGIVE = Action({ rmb=true, priority=1 })
PIGBANKGIVE.str = "Deposit"
PIGBANKGIVE.id = "PIGBANKGIVE"
PIGBANKGIVE.fn = function(act)
    if act.target ~= nil and act.target:IsValid() and act.target.prefab == "goldenpiggy"
            and act.invobject.prefab == "goldcoin" then
        local num = act.invobject.components.stackable.stacksize
        act.invobject:Remove()
        act.target.stored = act.target.stored + num
        act.target.components.workable:SetWorkLeft(1) -- Reset workable if piggy was empty
        return true
    end
end
AddAction(PIGBANKGIVE)

local PIGBANKTAKE = Action({ rmb=true, priority=1 })
PIGBANKTAKE.str = "Withdraw"
PIGBANKTAKE.id = "PIGBANKTAKE"
PIGBANKTAKE.fn = function(act)
    local target = act.target or act.invobject
    if target.prefab == "goldenpiggy" then
        local coins = SpawnPrefab("goldcoin")
        local maxstack = coins.components.stackable.maxsize
        local num = target.stored and math.min(maxstack, target.stored) or 0 

        if num > 0 then
            coins.components.stackable:SetStackSize(num)
            act.doer.components.inventory:GiveItem(coins)

            target.stored = target.stored - num
        else
            -- TODO: Make character say something "This piggy has nothing more to give."
        end

        if target.stored > 0 then
            target.components.workable:SetWorkLeft(1)
        end
        return true
    end
end
AddAction(PIGBANKTAKE)

local pigbank_give_pickhandler = ActionHandler(ACTIONS.PIGBANKGIVE, "doshortaction")
local pigbank_take_pickhandler = ActionHandler(ACTIONS.PIGBANKTAKE, "doshortaction")

AddStategraphActionHandler("wilson", pigbank_give_pickhandler)
AddStategraphActionHandler("wilson", pigbank_take_pickhandler)

AddComponentAction("USEITEM", "inventoryitem", function(inst, doer, target, actions, right)
    if right and inst.prefab == "goldcoin" and target.prefab == "goldenpiggy" then
        table.insert(actions, ACTIONS.PIGBANKGIVE)
    end
end)

AddComponentAction("INVENTORY", "inventoryitem", function(inst, doer, actions)
    if inst.prefab == "goldenpiggy" then
        table.insert(actions, ACTIONS.PIGBANKTAKE)
    end
end)

AddStategraphActionHandler("wilson_client", pigbank_give_pickhandler)
AddStategraphActionHandler("wilson_client", pigbank_take_pickhandler)

----------------
-- Attyla Stuff
----------------
-- Don't auto-attack Attyla
local comb_rep = GLOBAL.require "components/combat_replica"
local old_IsAlly = comb_rep.IsAlly
function comb_rep:IsAlly(guy,...)
        if guy:HasTag("attyla") then
			return true
		end
	return old_IsAlly(self,guy,...)
end

-- Make a special action for only being able to pick up Attyla with mouse-click
local ATTYLAPICK = GLOBAL.Action({ priority=1 })	
ATTYLAPICK.str = "Pick up"
ATTYLAPICK.id = "ATTYLAPICK"
ATTYLAPICK.fn = function(act)
	if act.doer.components.inventory ~= nil and
        act.target ~= nil and
        act.target.components.inventoryitem ~= nil and
		act.target:HasTag("attyla") then

        act.doer:PushEvent("onpickupitem", { item = act.target })
		act.doer.components.inventory:GiveItem(act.target, nil, act.target:GetPosition())
        return true
    end
end
AddAction(ATTYLAPICK)

local attyla_pickhandler = ActionHandler(ACTIONS.ATTYLAPICK, "doshortaction")
AddStategraphActionHandler("wilson", attyla_pickhandler)

AddComponentAction("SCENE", "inventoryitem", function(inst, doer, actions, right)
    if doer.replica.inventory ~= nil and inst:HasTag("attyla") and not inst:HasTag("fire") then
        table.insert(actions, ACTIONS.ATTYLAPICK)
    end
end)
AddStategraphActionHandler("wilson_client", attyla_pickhandler)

----------------------------------------------------------------
-- Show Me Mod Highlight Compatability
----------------------------------------------------------------
local containers = {"crate_wooden", "crate_wooden_gingerbread", "crate_wooden_3d", "crate_wooden_scary", "crate_wooden_present", "freezereye", "compost_box"}
TUNING.MONITOR_CHESTS = TUNING.MONITOR_CHESTS or {}
for k, v in pairs(containers) do
    TUNING.MONITOR_CHESTS[v] = true
end

----------------------------------------------------------------
-- Chests Don't Drop Contents on Hammer - Code by KoreanWaffles
----------------------------------------------------------------
AddPrefabPostInit("dragonflychest", function(inst)
if not GLOBAL.TheWorld.ismastersim then return inst end

    local function onhit(inst, worker)
        inst.AnimState:PlayAnimation("hit")
        inst.AnimState:PushAnimation("closed", false)
        if inst.components.container ~= nil then
            inst.components.container:Close()
        end
    end
        
    inst.components.workable:SetOnWorkCallback(onhit)
end)

AddPrefabPostInit("treasurechest", function(inst)
if not GLOBAL.TheWorld.ismastersim then return inst end

    local function onhit(inst, worker)
        if not inst:HasTag("burnt") then
            inst.AnimState:PlayAnimation("hit")
            inst.AnimState:PushAnimation("closed", false)
            if inst.components.container ~= nil then
                inst.components.container:Close()
            end
        end
    end

    inst.components.workable:SetOnWorkCallback(onhit)
end)

local function OnHitPreserver(inst, worker)
    inst.AnimState:PlayAnimation("hit")
    inst.AnimState:PushAnimation("closed", false)
    inst.components.container:Close()
end

local preservers = {"icebox", "saltbox"}
for k,v in pairs(preservers) do
    AddPrefabPostInit(v, function(v)
        if not GLOBAL.TheNet:GetIsServer() then return end
        v.components.workable:SetOnWorkCallback(OnHitPreserver)
    end)
end

local mushroom_lights = {"mushroom_light", "mushroom_light2"}
for k, v in pairs(mushroom_lights) do
    AddPrefabPostInit(v, function(inst)
        if not GLOBAL.TheWorld.ismastersim then return inst end

        local function IsLightOn(inst)
            return inst.Light:IsEnabled()
        end
        local function ClearSoundQueue(inst)
            if inst._soundtask ~= nil then
                inst._soundtask:Cancel()
                inst._soundtask = nil
            end
        end
    
        local function onworked(inst, worker, workleft)
            if workleft > 0 and not inst:HasTag("burnt") then
                ClearSoundQueue(inst)
                inst.AnimState:PlayAnimation(IsLightOn(inst) and "hit_on" or "hit")
                inst.AnimState:PushAnimation(IsLightOn(inst) and "idle_on" or "idle", false)

                if inst.components.container ~= nil then
                    inst.components.container:Close()
                end
            end
        end

        inst.components.workable:SetOnWorkCallback(onworked)
    end)
end

-------------------------------------------
-- Shadow Boss Fix - Code by KoreanWaffles 
-------------------------------------------	
local shadowpieces = {"shadow_knight", "shadow_bishop", "shadow_rook"}
for k, v in pairs(shadowpieces) do
    AddPrefabPostInit(v, function(v)
        GLOBAL.RemovePhysicsColliders(v)
        v.Physics:SetCollisionGroup(GLOBAL.COLLISION.SANITY)     
    end)
end

------------
-- Dark Axe
------------
--I reverted changes to this function, since it was causing a bug in DST -D
function EvergreenPostInit(inst)
    if GLOBAL.TheWorld.ismastersim then
        local oldonfinish = inst.components.workable.onfinish
        inst.components.workable.onfinish = function(inst, chopper)
            if chopper and chopper:HasTag("shadowchopper") then
                inst.components.lootdropper:AddChanceLoot( "livinglog", 0.08)
            end
            oldonfinish(inst, chopper)
        end
    end	  
end
 
local trees = {"evergreen", "evergreen_normal", "evergreen_tall", "evergreen_sparse", "evergreen_sparse_normal", "evergreen_sparse_tall", "deciduoustree", "deciduoustree_normal", "deciduoustree_tall"}
for k,v in pairs(trees) do AddPrefabPostInit(v, EvergreenPostInit) end

------------
-- Magic Bag/Pouch Auto-close Fix by Plataqueen
------------
-- fix for keeping the container open while riding
function OnUpdateContainerFn(self, dt)
    if self.opencount == 0 then
        self.inst:StopUpdatingComponent(self)
    else
        for opener, _ in pairs(self.openlist) do
            -- Don't auto-close if held in hands, backpack or riding, but do close if moved far or can no longer see it.
            if not (self.inst.components.inventoryitem ~= nil and
                    (self.inst.components.inventoryitem:IsHeldBy(opener) or
                        self.inst.components.inventoryitem:GetGrandOwner() == opener)) and
                    (--(opener.components.rider ~= nil and opener.components.rider:IsRiding()) or
                    not (opener:IsNear(self.inst, 3) and
                    GLOBAL.CanEntitySeeTarget(opener, self.inst))) then
                self:Close(opener)
            end
        end
    end
end

local function MagicContainerPostInit(inst)
    if GLOBAL.TheWorld.ismastersim then
        inst.components.container.OnUpdate = OnUpdateContainerFn
    end
end

AddPrefabPostInit("magicpouch", MagicContainerPostInit)
AddPrefabPostInit("magicbag", MagicContainerPostInit)
AddPrefabPostInit("icypack", MagicContainerPostInit)
AddPrefabPostInit("frostpack", MagicContainerPostInit)

-- fix for opening the container in the dark
local _oldrummagefn = ACTIONS.RUMMAGE.fn
ACTIONS.RUMMAGE.fn = function(act)
    local targ = act.target or act.invobject

    if targ ~= nil and targ.components.container ~= nil
        and (targ.prefab == "magicbag" or targ.prefab == "magicpouch"
            or targ.prefab == "icypack" or targ.prefab == "frostpack")
        and targ.components.container.canbeopened and not targ.components.container:IsOpenedBy(act.doer) then
        if targ.components.inventoryitem.owner ~= nil or GLOBAL.CanEntitySeeTarget(act.doer, targ) then
            act.doer:PushEvent("opencontainer", { container = targ })
            targ.components.container:Open(act.doer)
        end
        return true
    else
        return _oldrummagefn(act)
    end
end

----------------------------------------
-- Bees Duplicating Flower Bushes Patch
----------------------------------------
-- When bees attempt to spawn a new flower, if the flower it
-- tries to spawn is a flower bush, it will be replaced by a
-- regular flower. Add new values to the invalid_flowers table
-- to exclude other things from bee flower spawns. --KW
AddComponentPostInit("pollinator", function(self)
    if not GLOBAL.TheNet:GetIsServer() then return end
    local _CreateFlower = self.CreateFlower
    self.CreateFlower = function(self)
        local invalid_flowers = {"flowerbush"}
        for i, v in ipairs(invalid_flowers) do
            for j, w in ipairs(self.flowers) do
                if w.prefab == v then
                    self.flowers[j] = {prefab = "flower"}
                end
            end
        end
        _CreateFlower(self)
    end
end)
